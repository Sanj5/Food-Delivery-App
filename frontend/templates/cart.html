<!DOCTYPE html>
<html>
<head>
    <title>Shopping Cart - Food Delivery</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="navbar">
        <h1>üçΩÔ∏è Food Delivery</h1>
        <div>
            <span>Hello, {{ user_name }}!</span>
            <a href="{{ url_for('restaurants') }}">Back to Restaurants</a>
            <a href="{{ url_for('user_orders') }}">My Orders</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </div>
    
    <div class="container">
        <div class="cart-page">
            <h2>üõí Shopping Cart</h2>
            
            <div class="cart-wrapper">
                <div class="cart-items-section">
                    <h3>Items</h3>
                    <div id="cart-items-display" class="cart-items-list"></div>
                </div>
                
                <div class="cart-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">‚Çπ0</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery Fee:</span>
                        <span>‚Çπ0</span>
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="total">‚Çπ0</span>
                    </div>
                    
                    <form id="checkout-form" onsubmit="return proceedToCheckout(event)">
                        <input type="hidden" name="restaurant_id" id="restaurant_id">
                        <input type="hidden" name="items" id="items-input" value="[]">
                        <input type="hidden" name="total" id="total-input" value="0">
                        <button type="submit" class="btn btn-primary btn-large" id="checkout-btn" disabled>Proceed to Checkout</button>
                    </form>
                    
                    <a href="{{ url_for('restaurants') }}" class="btn btn-secondary btn-large">Continue Shopping</a>
                </div>
            </div>
            
            <div id="empty-cart" class="empty-state" style="display: none;">
                <p>üõí Your cart is empty</p>
                <p><a href="{{ url_for('restaurants') }}" class="btn">Start Ordering</a></p>
            </div>
        </div>
    </div>
    
    <script>
        let cart = {};
        let currentRestaurant = {};
        
        function loadCart() {
            const savedCart = localStorage.getItem('cart');
            const savedRestaurant = localStorage.getItem('currentRestaurant');
            
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }
            if (savedRestaurant) {
                currentRestaurant = JSON.parse(savedRestaurant);
            }
            
            updateCartDisplay();
        }
        
        function updateCartDisplay() {
            const cartItemsDiv = document.getElementById('cart-items-display');
            const emptyCart = document.getElementById('empty-cart');
            const checkoutForm = document.getElementById('checkout-form');
            const hasItems = Object.keys(cart).length > 0;
            
            if (!hasItems) {
                cartItemsDiv.style.display = 'none';
                checkoutForm.style.display = 'none';
                emptyCart.style.display = 'block';
                return;
            }
            
            cartItemsDiv.style.display = 'block';
            checkoutForm.style.display = 'block';
            emptyCart.style.display = 'none';
            
            let html = '';
            let total = 0;
            
            for (let id in cart) {
                let item = cart[id];
                let itemTotal = item.price * item.qty;
                total += itemTotal;
                html += `
                    <div class="cart-item">
                        <div class="item-details">
                            <h4>${item.name}</h4>
                            <p class="item-price">‚Çπ${item.price}</p>
                        </div>
                        <div class="item-controls">
                            <button type="button" class="qty-btn" onclick="decreaseQty('${id}')">‚àí</button>
                            <input type="number" value="${item.qty}" min="1" class="qty-display" disabled>
                            <button type="button" class="qty-btn" onclick="increaseQty('${id}')">+</button>
                            <span class="item-total">‚Çπ${itemTotal.toFixed(2)}</span>
                            <button type="button" class="btn-remove" onclick="removeFromCart('${id}')">Remove</button>
                        </div>
                    </div>
                `;
            }
            
            cartItemsDiv.innerHTML = html;
            document.getElementById('subtotal').innerText = '‚Çπ' + total.toFixed(2);
            document.getElementById('total').innerText = '‚Çπ' + total.toFixed(2);
            document.getElementById('total-input').value = total.toFixed(2);
            document.getElementById('restaurant_id').value = currentRestaurant.id || '';
            
            let items = [];
            for (let id in cart) {
                items.push({ item_id: id, item_name: cart[id].name, quantity: cart[id].qty });
            }
            document.getElementById('items-input').value = JSON.stringify(items);
            document.getElementById('checkout-btn').disabled = !hasItems;
        }
        
        function increaseQty(itemId) {
            if (cart[itemId]) {
                cart[itemId].qty += 1;
                saveCart();
                updateCartDisplay();
            }
        }
        
        function decreaseQty(itemId) {
            if (cart[itemId] && cart[itemId].qty > 1) {
                cart[itemId].qty -= 1;
                saveCart();
                updateCartDisplay();
            }
        }
        
        function removeFromCart(itemId) {
            delete cart[itemId];
            saveCart();
            updateCartDisplay();
        }
        
        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }
        
        function proceedToCheckout(event) {
            event.preventDefault();
            const form = document.getElementById('checkout-form');
            form.action = '{{ url_for("create_order") }}';
            form.method = 'POST';
            form.submit();
        }
        
        // Load cart on page load
        window.addEventListener('load', loadCart);
    </script>
</body>
</html>
